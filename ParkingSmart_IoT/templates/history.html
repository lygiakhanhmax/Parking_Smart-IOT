<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Lịch Sử Ra Vào</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-camera"></i> Parking AI</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Dashboard</a>
                <a class="nav-link active" href="/history">Lịch Sử</a>
                <a class="nav-link" href="/registered">Đăng Ký Xe</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3><i class="fas fa-history"></i> Nhật Ký Ra Vào</h3>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory()">
                <i class="fas fa-sync"></i> Làm mới
            </button>
        </div>

        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Ảnh</th>
                                <th>Biển Số</th>
                                <th>Thời Gian Vào</th>
                                <th>Thời Gian Ra</th>
                                <th>Phí (VND)</th>
                                <th>Trạng Thái</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <img id="modal-img-src" src="" class="img-fluid rounded">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <script>
        const socket = io();
        
        // Format tiền tệ
        const fmtMoney = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

        // Hàm load dữ liệu ban đầu
        async function loadHistory() {
            try {
                const res = await fetch('/api/history');
                const data = await res.json();
                const tbody = document.getElementById('history-body');
                tbody.innerHTML = '';
                
                data.forEach(row => {
                    tbody.innerHTML += renderRow(row);
                });
            } catch (e) {
                console.error("Lỗi tải history:", e);
            }
        }

        // Chuyển đổi đường dẫn ảnh từ DB (static/captures/...) sang URL (/captures/...)
        function fixImgPath(path) {
            if (!path) return '';
            // DB lưu "static/captures/filename.jpg", Flask route cần "/captures/filename.jpg"
            return path.replace('static/captures', '/captures').replace('static\\captures', '/captures');
        }

        function renderRow(row) {
            const imgUrl = fixImgPath(row.image_path);
            const feeDisplay = row.fee ? fmtMoney.format(row.fee) : '-';
            const statusBadge = row.status === 'Out' ? 'bg-secondary' : (row.status === 'In' ? 'bg-success' : 'bg-danger');
            
            return `
                <tr>
                    <td>${row.id}</td>
                    <td>
                        <img src="${imgUrl}" class="rounded" width="60" height="40" 
                             style="object-fit: cover; cursor: pointer;" 
                             onclick="showImage('${imgUrl}')">
                    </td>
                    <td class="fw-bold">${row.plate}</td>
                    <td>${row.entry_time}</td>
                    <td>${row.exit_time || '--'}</td>
                    <td>${feeDisplay}</td>
                    <td><span class="badge ${statusBadge}">${row.status}</span></td>
                </tr>
            `;
        }

        function showImage(url) {
            document.getElementById('modal-img-src').src = url;
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        // Realtime update: Khi có xe vào/ra, tự động chèn lên đầu bảng
        socket.on('history_update', (data) => {
            // Data từ socket hơi khác format DB một chút, ta map lại cho khớp
            // Socket data: { plate, action, image, status, time, fee }
            // Table cần: id (bỏ qua), image_path, plate, entry_time, exit_time, fee, status
            
            // Vì là realtime, ta chỉ cần reload lại bảng hoặc chèn dòng giả lập. 
            // Cách tốt nhất: Gọi lại loadHistory() để đồng bộ ID từ DB
            loadHistory(); 
        });

        // Khởi chạy
        document.addEventListener("DOMContentLoaded", loadHistory);
    </script>
</body>
</html>